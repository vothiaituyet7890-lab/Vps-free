<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ƒê∆°n ƒë·∫∑t s√¢n c·ªßa t√¥i - SportBooking</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      .bookings-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      .page-header {
        margin-bottom: 32px;
      }
      .page-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 0 0 12px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .page-header p {
        font-size: 1.1rem;
        color: var(--muted);
        margin: 0;
      }
      .booking-card {
        background: white;
        border-radius: 20px;
        padding: 32px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.12);
        border: 2px solid rgba(139, 92, 246, 0.1);
        transition: all 0.3s ease;
      }
      .booking-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 32px rgba(139, 92, 246, 0.2);
        border-color: rgba(139, 92, 246, 0.3);
      }
      .booking-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 2px solid rgba(139, 92, 246, 0.1);
      }
      .booking-id {
        font-weight: 700;
        font-size: 1.3rem;
        color: var(--text);
        font-family: monospace;
      }
      .booking-status {
        padding: 10px 20px;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .status-pending {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
      }
      .status-approved {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #065f46;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      }
      .status-rejected {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #b91c1c;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      }
      .status-cancelled {
        background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        color: #4b5563;
        box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
      }
      .booking-card.cancelled {
        background: #f3f4f6;
        border-color: #e5e7eb;
        box-shadow: none;
        opacity: 0.85;
      }
      .booking-card.cancelled .detail-value,
      .booking-card.cancelled .booking-id {
        color: #6b7280;
      }
      .booking-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
        background: rgba(139, 92, 246, 0.03);
        padding: 24px;
        border-radius: 16px;
      }
      .detail-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .detail-group h4 {
        margin: 0;
        color: var(--muted);
        font-size: 0.95rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .detail-value {
        font-weight: 700;
        font-size: 1.15rem;
        color: var(--text);
      }
      .booking-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        padding-top: 20px;
        border-top: 2px solid rgba(139, 92, 246, 0.1);
      }
      .booking-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .booking-actions .btn {
        min-width: 140px;
      }
      .no-bookings {
        text-align: center;
        padding: 4rem 1rem;
        color: #6b7280;
      }
      .no-bookings-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a href="index.html" class="logo">SportBooking</a>
        <nav class="nav">
          <a href="index.html">Trang ch·ªß</a>
          <a href="gioithieu.html">Gi·ªõi thi·ªáu</a>
          <a href="timkiem.html">T√¨m ki·∫øm</a>
          <a href="danh-sach-san.html">Danh s√°ch s√¢n</a>
          <a href="lienhe.html">Li√™n h·ªá</a>
          <a href="#" class="btn btn-primary btn-sm" id="userMenu">T√†i kho·∫£n</a>
        </nav>
      </div>
    </header>

    <main class="section">
      <div class="bookings-container">
        <div class="page-header">
          <h1>üìã Chi ti·∫øt s√¢n ƒë√£ ƒë·∫∑t</h1>
          <p>Xem v√† qu·∫£n l√Ω c√°c ƒë∆°n ƒë·∫∑t s√¢n c·ªßa b·∫°n</p>
        </div>
        
        <div id="bookingsList">
          <!-- Danh s√°ch ƒë∆°n ƒë·∫∑t s√¢n s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </div>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>¬© 2023 SportBooking. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
      </div>
    </footer>

    <script src="auth.js"></script>
    <script>
      // H√†m ƒë·ªãnh d·∫°ng ng√†y th√°ng
      function formatDate(dateString) {
        const options = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        };
        return new Date(dateString).toLocaleDateString('vi-VN', options);
      }

      // H√†m hi·ªÉn th·ªã tr·∫°ng th√°i ƒë∆°n h√†ng
      function getStatusBadge(status) {
        const normalized = (status || '').toLowerCase() === 'canceled' ? 'cancelled' : (status || '').toLowerCase();
        const statusConfig = {
          'pending': { text: '‚è≥ ƒêang duy·ªát', class: 'status-pending' },
          'approved': { text: '‚úÖ ƒê√£ duy·ªát', class: 'status-approved' },
          'rejected': { text: '‚ùå ƒê√£ t·ª´ ch·ªëi', class: 'status-rejected' },
          'cancelled': { text: 'üö´ ƒê√£ h·ªßy', class: 'status-cancelled' }
        };
        
        const config = statusConfig[normalized] || { text: status, class: 'status-pending' };
        return `<span class="booking-status ${config.class}">${config.text}</span>`;
      }

      // H√†m hi·ªÉn th·ªã danh s√°ch ƒë∆°n ƒë·∫∑t s√¢n
      function displayBookings(bookings) {
        const bookingsList = document.getElementById('bookingsList');
        
        // Hi·ªÉn th·ªã c·∫£ c√°c ƒë∆°n ƒë√£ h·ªßy ƒë·ªÉ ƒë·ªëi chi·∫øu v·ªõi admin
        bookings = bookings || [];

        if (!bookings || bookings.length === 0) {
          bookingsList.innerHTML = `
            <div class="no-bookings">
              <div class="no-bookings-icon">üìã</div>
              <h3>Ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t s√¢n n√†o</h3>
              <p>B·∫°n ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t s√¢n n√†o. H√£y ƒë·∫∑t s√¢n ngay h√¥m nay!</p>
              <a href="datsan.html" class="btn btn-primary mt-4">ƒê·∫∑t s√¢n ngay</a>
            </div>
          `;
          return;
        }

        // S·∫Øp x·∫øp theo th·ªùi gian t·∫°o m·ªõi nh·∫•t
        bookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        let html = '';
        
        bookings.forEach(booking => {
          const bookingDate = new Date(booking.date);
          const formattedDate = bookingDate.toLocaleDateString('vi-VN', { 
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          
          const raw = (booking.statusRaw || '').toString().toLowerCase();
          const base = (booking.status || '').toString().toLowerCase();
          const stripMarks = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[\s_]+/g, '');
          const normRaw = stripMarks(raw);
          const normBase = stripMarks(base);
          const isCancelled = normBase === 'cancelled' || normBase === 'canceled' || normBase.includes('cancel') || normRaw.includes('huy') || normRaw.includes('cancel');
          const displayStatus = isCancelled ? 'cancelled' : (base || 'pending');
          html += `
            <div class="booking-card ${isCancelled ? 'cancelled' : ''}" id="booking-card-${booking.id}" data-status="${displayStatus}" data-statusraw="${(booking.statusRaw || '').replace(/"/g,'&quot;')}">
              <div class="booking-header">
                <div class="booking-id">M√£ ƒë∆°n: ${booking.id}</div>
                ${getStatusBadge(displayStatus)}
              </div>
              
              <div class="booking-details">
                <div class="detail-group">
                  <h4>S√¢n ƒë·∫∑t</h4>
                  <div class="detail-value">S√¢n ${booking.court}</div>
                </div>
                
                <div class="detail-group">
                  <h4>Ng√†y ƒë√°</h4>
                  <div class="detail-value">${formattedDate}</div>
                </div>
                
                <div class="detail-group">
                  <h4>Khung gi·ªù</h4>
                  <div class="detail-value">${booking.time}</div>
                </div>
                
                <div class="detail-group">
                  <h4>Thanh to√°n</h4>
                  <div class="detail-value">${getPaymentMethod(booking.paymentMethod)}</div>
                </div>
              </div>
              
              <div class="booking-footer">
                <div class="detail-group">
                  <h4>T·ªïng ti·ªÅn</h4>
                  <div class="detail-value" style="font-size: 1.25rem; font-weight: 700; color: #1f2937;">
                    ${(booking.amount || 0).toLocaleString('vi-VN')} VNƒê
                  </div>
                </div>
                
                <div class="booking-actions">
                  ${(!isCancelled && (displayStatus === 'approved' || displayStatus === 'pending')) ? `
                    <button class="btn btn-danger" onclick="cancelBooking('${booking.id}')">
                      ‚ùå H·ªßy ƒë·∫∑t s√¢n
                    </button>
                  ` : ''}
                  <button class="btn btn-primary" onclick="viewBookingDetails('${booking.id}')">
                    üëÅÔ∏è Xem chi ti·∫øt
                  </button>
                </div>
              </div>
            </div>
          `;
        });
        
        bookingsList.innerHTML = html;
      }
      
      // H√†m l·∫•y t√™n ph∆∞∆°ng th·ª©c thanh to√°n
      function getPaymentMethod(method) {
        const methods = {
          'momo': 'V√≠ ƒëi·ªán t·ª≠ Momo',
          'bank': 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng',
          'cash': 'Thanh to√°n tr·ª±c ti·∫øp'
        };
        return methods[method] || method || 'Ch∆∞a x√°c ƒë·ªãnh';
      }
      
      // H√†m h·ªßy ƒë∆°n ƒë·∫∑t s√¢n
      function cancelBooking(bookingId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n ƒë·∫∑t s√¢n n√†y?')) {
          return;
        }
        fetch('/DOANWEB/api/cancel-booking.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bookingId: Number(bookingId) })
        })
        .then(r => r.json())
        .then(resp => {
          if (resp && resp.success) {
            showToast('ƒê√£ h·ªßy ƒë∆°n ƒë·∫∑t s√¢n', resp.message || 'H·ªßy th√†nh c√¥ng', 'success');
            // Optimistic UI: ƒë√°nh d·∫•u th·∫ª l√† ƒë√£ h·ªßy thay v√¨ x√≥a kh·ªèi DOM
            const card = document.getElementById('booking-card-' + bookingId);
            if (card) {
              // Th√™m l·ªõp cancelled ƒë·ªÉ t√¥ x√°m
              card.classList.add('cancelled');

              // C·∫≠p nh·∫≠t badge tr·∫°ng th√°i
              const header = card.querySelector('.booking-header');
              if (header) {
                const oldBadge = header.querySelector('.booking-status');
                const newBadge = document.createElement('span');
                newBadge.className = 'booking-status status-cancelled';
                newBadge.textContent = 'üö´ ƒê√£ h·ªßy';
                if (oldBadge) {
                  oldBadge.replaceWith(newBadge);
                } else {
                  header.appendChild(newBadge);
                }
              }

              // ·∫®n n√∫t h·ªßy n·∫øu c√≤n xu·∫•t hi·ªán
              const cancelBtn = card.querySelector('.btn.btn-danger');
              if (cancelBtn && cancelBtn.parentElement) {
                cancelBtn.parentElement.removeChild(cancelBtn);
              }
            }
            // ƒê·ªìng b·ªô l·∫°i danh s√°ch t·ª´ server ·ªü h·∫≠u tr∆∞·ªùng
            setTimeout(() => loadUserBookings(), 150);
          } else {
            const msg = (resp && resp.message) ? String(resp.message).toLowerCase() : '';
            showToast('Kh√¥ng th·ªÉ h·ªßy', (resp && resp.message) || 'Vui l√≤ng th·ª≠ l·∫°i', 'error');
            // N·∫øu backend b√°o ƒë√£ h·ªßy r·ªìi -> c·∫≠p nh·∫≠t UI th√†nh ƒë√£ h·ªßy
            if (msg.includes('da huy') || msg.includes('ƒë√£ h·ªßy') || msg.includes('huy')) {
              const card = document.getElementById('booking-card-' + bookingId);
              if (card) {
                card.classList.add('cancelled');
                // c·∫≠p nh·∫≠t badge
                const header = card.querySelector('.booking-header');
                if (header) {
                  const oldBadge = header.querySelector('.booking-status');
                  const newBadge = document.createElement('span');
                  newBadge.className = 'booking-status status-cancelled';
                  newBadge.textContent = 'üö´ ƒê√£ h·ªßy';
                  if (oldBadge) oldBadge.replaceWith(newBadge); else header.appendChild(newBadge);
                }
                const cancelBtn = card.querySelector('.btn.btn-danger');
                if (cancelBtn && cancelBtn.parentElement) cancelBtn.parentElement.removeChild(cancelBtn);
              }
            }
          }
        })
        .catch(() => showToast('L·ªói', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß', 'error'));
      }
      
      // H√†m xem chi ti·∫øt ƒë∆°n ƒë·∫∑t s√¢n
      function viewBookingDetails(bookingId) {
        window.location.href = `chi-tiet-dat-san.html?id=${bookingId}`;
      }
      
      // H√†m t·∫£i danh s√°ch ƒë∆°n ƒë·∫∑t s√¢n c·ªßa ng∆∞·ªùi d√πng
      function loadUserBookings() {
        const currentUser = getCurrentUser();
        if (!currentUser) {
          window.location.href = '/DOANWEB/login.html?returnUrl=/DOANWEB/lich-dat-san-cua-toi.html';
          return;
        }
        
        // G·ªçi API ƒë·ªÉ l·∫•y danh s√°ch ƒë∆°n ƒë·∫∑t s√¢n theo t√†i kho·∫£n hi·ªán t·∫°i
        fetch('/DOANWEB/api/my-bookings.php?_=' + Date.now(), { cache: 'no-store' })
          .then(r => r.json())
          .then(resp => {
            if (resp && resp.success) {
              displayBookings(resp.bookings || []);
            } else {
              displayBookings([]);
            }
          })
          .catch(() => displayBookings([]));
      }
      
      // Kh·ªüi t·∫°o trang
      document.addEventListener('DOMContentLoaded', function() {
        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        checkLoginStatus();
        
        // T·∫£i danh s√°ch ƒë∆°n ƒë·∫∑t s√¢n
        loadUserBookings();
        
        // C·∫≠p nh·∫≠t giao di·ªán ng∆∞·ªùi d√πng
        updateUIForLoggedInUser();
      });
      
      // H√†m c·∫≠p nh·∫≠t giao di·ªán ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p
      function updateUIForLoggedInUser() {
        const currentUser = getCurrentUser();
        const userMenu = document.getElementById('userMenu');
        
        if (currentUser) {
          userMenu.textContent = currentUser.name || 'T√†i kho·∫£n';
          userMenu.href = '/DOANWEB/settings.html';
          
          // Th√™m menu dropdown
          userMenu.insertAdjacentHTML('afterend', `
            <div class="user-dropdown">
              <a href="/DOANWEB/settings.html">T√†i kho·∫£n c·ªßa t√¥i</a>
              <a href="/DOANWEB/lich-dat-san-cua-toi.html">ƒê∆°n ƒë·∫∑t s√¢n</a>
              <a href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a>
            </div>
          `);
        } else {
          userMenu.textContent = 'ƒêƒÉng nh·∫≠p';
          userMenu.href = '/DOANWEB/login.html';
        }
      }
      
      // H√†m hi·ªÉn th·ªã th√¥ng b√°o
      function showToast(title, message, type = 'info') {
        const oldToast = document.querySelector('.toast-notification');
        if (oldToast) {
          oldToast.remove();
        }
      
        const icons = {
          error: '‚ùå',
          success: '‚úÖ',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è',
        };
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.innerHTML = `
          <div class="toast-icon">${icons[type] || icons.info}</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        `;
      
        document.body.appendChild(toast);
      
        // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
        setTimeout(() => {
          if (toast.parentElement) {
            toast.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
          }
        }, 5000);
      }
    </script>
  </body>
</html>
